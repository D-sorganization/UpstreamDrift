name: Jules Competitor Analyst (Market Intelligence)

on:
  workflow_call:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * 1"  # Weekly on Mondays at 2 AM UTC (within midnight-4 AM window)

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  competitor-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Jules
        run: npm install -g @google/jules

      - name: Gather Existing Analysis
        run: |
          mkdir -p .jules/competitor_data
          mkdir -p docs/competitive_analysis

          # Find existing competitor analysis files
          find . -name "*.md" -type f \
            ! -path "./.git/*" \
            -exec grep -l -i "competitor\|competitive\|market\|trackman\|foresight\|flightscope\|garmin\|toptracer" {} \; \
            > .jules/competitor_data/existing_analysis.txt 2>/dev/null || true

          # Copy existing comprehensive analysis if exists
          if [ -f "docs/assessments/archive/Market_Competitive_Patent_Assessment.md" ]; then
            cp docs/assessments/archive/Market_Competitive_Patent_Assessment.md .jules/competitor_data/
          fi

      - name: Jules Competitor Analysis
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
                    set -e
                    DATE=$(date +%Y-%m-%d)
                    REPO="${{ github.repository }}"
                    API_BASE="https://jules.googleapis.com/v1alpha"
          
                    # Check if API key is configured
                    if [ -z "$JULES_API_KEY" ]; then
                      echo "::warning::JULES_API_KEY not configured. Skipping Jules task."
                      exit 0
                    fi
          
                    echo "Looking up repository source..."
                    SOURCES=$(curl -sf -H "X-Goog-Api-Key: $JULES_API_KEY" "$API_BASE/sources" || echo '{"sources":[]}')
          
                    OWNER=$(echo "$REPO" | cut -d'/' -f1)
                    REPO_NAME=$(echo "$REPO" | cut -d'/' -f2)
          
                    SOURCE_ID=$(echo "$SOURCES" | jq -r ".sources[] | select(.githubRepo.owner == \"$OWNER\" and .githubRepo.repo == \"$REPO_NAME\") | .name" | head -1)
          
                    if [ -z "$SOURCE_ID" ] || [ "$SOURCE_ID" = "null" ]; then
                      echo "::warning::Repository $REPO not found in Jules sources."
                      exit 0
                    fi
          
                    echo "Found source: $SOURCE_ID"
          
                    # Create session prompt
                    PROMPT=$(cat << 'PROMPT_EOF'
          '
                    You are the COMPETITOR ANALYST - a market intelligence specialist for golf technology.
          
                    ## Your Mission
                    Maintain and update a comprehensive competitor analysis document.
          
                    ## Target Document
                    Create/Update: docs/competitive_analysis/COMPETITOR_ANALYSIS.md
          
                    This should be a SINGLE, COMPREHENSIVE document that is continuously refined.
                    Do NOT create dated versions - update the master document.
          
                    ## Competitor Categories
          
                    ### 1. Launch Monitor Hardware
                    | Competitor | Products | Key Features | Price Range | Market Position |
                    - TrackMan (Radar-based, gold standard)
                    - Foresight Sports (GCQuad, photometric)
                    - FlightScope (Mevo, Mevo+, X3)
                    - Full Swing Kit
                    - Garmin Approach R10
                    - Rapsodo MLM2PRO
                    - Uneekor (QED, EYE XO)
          
                    ### 2. Software/Analytics Platforms
                    - TrackMan Performance Studio
                    - Foresight FSX Play/FSX Pro
                    - E6 Connect
                    - TruGolf (Home simulators)
                    - GSPro (Open platform)
                    - OpenGolf (Open source)
          
                    ### 3. Biomechanics/Instruction
                    - K-Vest/K-Motion (3D biofeedback)
                    - GEARS Golf (Motion capture)
                    - Sportsbox AI (Markerless)
                    - V1 Sports (Video analysis)
                    - Hackmotion (Wrist sensor)
                    - Swing Catalyst (Force plates)
                    - BodiTrak (Pressure mapping)
          
                    ### 4. Open Source Alternatives
                    - OpenSim (Stanford)
                    - OpenCap
                    - OpenBiomechanics Project
          
                    ## Analysis Framework
          
                    For each competitor, document:
                    1. **Core Value Proposition**
                    2. **Key Features** (what they do well)
                    3. **Limitations** (gaps we can fill)
                    4. **Pricing Model**
                    5. **Target Market**
                    6. **Technology Stack** (if known)
                    7. **Recent Updates** (new features/products)
                    8. **Our Differentiation** (how we compare)
          
                    ## Feature Comparison Matrix
          
                    Create a detailed feature matrix:
                    | Feature | Us | TrackMan | Foresight | FlightScope | K-Motion | Sportsbox |
                    |---------|----|---------|-----------| ... |
          
                    Categories:
                    - Ball Flight Data
                    - Club Data
                    - Body Movement Analysis
                    - 3D Visualization
                    - Export/API
                    - Pricing
                    - Platform Support
          
                    ## Market Positioning
          
                    ### Our Advantages
                    - Open source / transparency
                    - Multi-engine integration
                    - Scientific rigor
                    - Cost (free)
                    - Customizability
          
                    ### Our Gaps
                    - No hardware
                    - Less polished UI
                    - Smaller community
                    - Less validation data
          
                    ### Strategic Opportunities
                    Identify where competitors are weak and we could excel.
          
                    ## Update Instructions
          
                    1. Review existing analysis in .jules/competitor_data/
                    2. Merge new information into the master document
                    3. Keep historical data but update "current" information
                    4. Add "Last Updated: $DATE" at top
                    5. Flag any significant market changes for attention
          
                    DO NOT MAKE CODE CHANGES. This is a RESEARCH workflow.
                    PROMPT_EOF
                    )
          
                    echo "Creating Jules session..."
                    REQUEST_JSON=$(jq -n \
                      --arg prompt "$PROMPT" \
                      --arg source "$SOURCE_ID" \
                      '{
                        prompt: $prompt,
                        sourceContext: {
                          source: $source,
                          githubRepoContext: {
                            startingBranch: "main"
                          }
                        },
                        automationMode: "AUTO_CREATE_PR"
                      }')
          
                    echo "Request: $REQUEST_JSON"
          
                    HTTP_CODE=$(curl -s -o /tmp/session_response.json -w "%{http_code}" -X POST \
                      -H "X-Goog-Api-Key: $JULES_API_KEY" \
                      -H "Content-Type: application/json" \
                      -d "$REQUEST_JSON" \
                      "$API_BASE/sessions")
          
                    SESSION_RESPONSE=$(cat /tmp/session_response.json)
                    echo "HTTP Status: $HTTP_CODE"
          
                    if [ "$HTTP_CODE" != "200" ]; then
                      echo "::error::Jules API returned HTTP $HTTP_CODE"
                      exit 1
                    fi
          
                    SESSION_ID=$(echo "$SESSION_RESPONSE" | jq -r '.name')
                    echo "Created session: $SESSION_ID"
          
                    # Poll for completion
                    MAX_WAIT=1800
                    POLL_INTERVAL=30
                    ELAPSED=0
          
                    while [ $ELAPSED -lt $MAX_WAIT ]; do
                      SESSION_STATUS=$(curl -sf -H "X-Goog-Api-Key: $JULES_API_KEY" "$API_BASE/$SESSION_ID")
                      STATE=$(echo "$SESSION_STATUS" | jq -r '.state')
                      echo "Session state: $STATE (elapsed: ${ELAPSED}s)"
          
                      case "$STATE" in
                        "COMPLETED"|"SUBMITTED")
                          echo "Session completed successfully!"
                          break
                          ;;
                        "FAILED"|"CANCELLED")
                          echo "::error::Session $STATE"
                          exit 1
                          ;;
                      esac
                      sleep $POLL_INTERVAL
                      ELAPSED=$((ELAPSED + POLL_INTERVAL))
                    done
          


      - name: Commit Analysis
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(competitive): update competitor analysis"
          file_pattern: "docs/competitive_analysis/*.md"
