name: Pragmatic Programmer Review

# Weekly automated code review based on "The Pragmatic Programmer" principles
# by David Thomas and Andrew Hunt

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      create_issues:
        description: 'Create GitHub issues for findings'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'Dry run mode (no issues created)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  schedule:
    # Run weekly on Sundays at 3:00 AM UTC
    - cron: "0 3 * * 0"

permissions:
  contents: write
  pull-requests: write
  issues: write

# Prevent concurrent runs
concurrency:
  group: pragmatic-review-${{ github.repository }}
  cancel-in-progress: false

env:
  # Maximum issues to create per run
  MAX_ISSUES: 10

jobs:
  pragmatic-review:
    name: Pragmatic Programmer Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Pragmatic Programmer Review
        id: review
        run: |
          DATE=$(date +%Y-%m-%d)
          REPORT_DIR="docs/assessments/pragmatic_programmer"
          mkdir -p "$REPORT_DIR"

          # Run the review script
          python scripts/pragmatic_programmer_review.py \
            --path . \
            --output "$REPORT_DIR/review_${DATE}.md" \
            --json-output "$REPORT_DIR/review_${DATE}.json" \
            ${{ inputs.dry_run == 'true' && '--dry-run' || '' }} \
            || true

          # Parse results for summary
          if [ -f "$REPORT_DIR/review_${DATE}.json" ]; then
            SCORE=$(cat "$REPORT_DIR/review_${DATE}.json" | jq -r '.overall_score')
            CRITICAL=$(cat "$REPORT_DIR/review_${DATE}.json" | jq -r '.issue_summary.CRITICAL')
            MAJOR=$(cat "$REPORT_DIR/review_${DATE}.json" | jq -r '.issue_summary.MAJOR')
            MINOR=$(cat "$REPORT_DIR/review_${DATE}.json" | jq -r '.issue_summary.MINOR')

            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "major=$MAJOR" >> $GITHUB_OUTPUT
            echo "minor=$MINOR" >> $GITHUB_OUTPUT
            echo "report_path=$REPORT_DIR/review_${DATE}.md" >> $GITHUB_OUTPUT
            echo "json_path=$REPORT_DIR/review_${DATE}.json" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Issues
        if: inputs.create_issues != 'false' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y-%m-%d)
          JSON_PATH="docs/assessments/pragmatic_programmer/review_${DATE}.json"

          if [ ! -f "$JSON_PATH" ]; then
            echo "No review results found"
            exit 0
          fi

          # Get existing issues to avoid duplicates
          EXISTING=$(gh issue list --state open --label "pragmatic-programmer" --json title --jq '.[].title' || echo "")

          # Create issues for CRITICAL and MAJOR findings
          ISSUES_CREATED=0
          cat "$JSON_PATH" | jq -c '.issues[] | select(.severity == "CRITICAL" or .severity == "MAJOR")' | while read -r issue; do
            if [ $ISSUES_CREATED -ge ${{ env.MAX_ISSUES }} ]; then
              echo "Reached max issues limit (${{ env.MAX_ISSUES }})"
              break
            fi

            TITLE=$(echo "$issue" | jq -r '"[PragProg] \(.severity): \(.title)"')
            PRINCIPLE=$(echo "$issue" | jq -r '.principle')
            SEVERITY=$(echo "$issue" | jq -r '.severity')
            DESC=$(echo "$issue" | jq -r '.description')
            RECOMMENDATION=$(echo "$issue" | jq -r '.recommendation')
            FILES=$(echo "$issue" | jq -r '.files | if . then .[:3] | join(", ") else "Repository-wide" end')

            # Check if issue already exists
            if echo "$EXISTING" | grep -qF "$TITLE"; then
              echo "Issue already exists: $TITLE"
              continue
            fi

            BODY=$(cat <<EOF
          ## Pragmatic Programmer Review Finding

          **Principle**: $PRINCIPLE
          **Severity**: $SEVERITY
          **Identified**: $DATE

          ### Description

          $DESC

          ### Recommendation

          $RECOMMENDATION

          ### Affected Files

          $FILES

          ---
          *Auto-generated by Pragmatic Programmer Review workflow*
          EOF
          )

            # Create the issue
            gh issue create \
              --title "$TITLE" \
              --body "$BODY" \
              --label "pragmatic-programmer,automated-review" 2>/dev/null || \
            gh issue create \
              --title "$TITLE" \
              --body "$BODY" 2>/dev/null || \
            echo "Failed to create issue: $TITLE"

            ISSUES_CREATED=$((ISSUES_CREATED + 1))
          done

          echo "Created $ISSUES_CREATED issues"

      - name: Update Latest Symlink
        run: |
          DATE=$(date +%Y-%m-%d)
          REPORT_DIR="docs/assessments/pragmatic_programmer"

          # Create/update latest symlink (as a file copy for git)
          if [ -f "$REPORT_DIR/review_${DATE}.md" ]; then
            cp "$REPORT_DIR/review_${DATE}.md" "$REPORT_DIR/LATEST.md"
          fi

      - name: Commit and Push Report
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(assessment): Pragmatic Programmer Review ${{ steps.review.outputs.score }}/10"
          file_pattern: "docs/assessments/pragmatic_programmer/*"

      - name: Generate Summary
        run: |
          echo "## Pragmatic Programmer Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Score**: ${{ steps.review.outputs.score }}/10" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issue Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: ${{ steps.review.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
          echo "- Major: ${{ steps.review.outputs.major }}" >> $GITHUB_STEP_SUMMARY
          echo "- Minor: ${{ steps.review.outputs.minor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Markdown Report](${{ steps.review.outputs.report_path }})" >> $GITHUB_STEP_SUMMARY
          echo "- [JSON Results](${{ steps.review.outputs.json_path }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Based on 'The Pragmatic Programmer' by David Thomas and Andrew Hunt*" >> $GITHUB_STEP_SUMMARY
