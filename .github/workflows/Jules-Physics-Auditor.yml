name: Jules Physics Auditor (Technical/Scientific Review)

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      focus_area:
        description: 'Focus area for audit'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - biomechanics
          - ball_flight
          - equipment
          - statistics
  schedule:
    - cron: "0 2 * * 2,5"  # Tuesdays and Fridays at 2 AM UTC (within midnight-4 AM window)

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  physics-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt || true
          npm install -g @google/jules

      - name: Identify Physics-Critical Files
        run: |
          mkdir -p .jules/physics_data

          # Find files with physics/math implementations
          find . -name "*.py" -type f \
            ! -path "./.git/*" ! -path "./venv/*" ! -path "./.venv/*" \
            -exec grep -l "numpy\|scipy\|math\." {} \; \
            > .jules/physics_data/math_files.txt 2>/dev/null || true

          # Find biomechanics-related files
          grep -rl "kinematic\|biomech\|velocity\|acceleration\|force\|torque\|momentum" \
            --include="*.py" . --exclude-dir=".git" --exclude-dir="venv" \
            > .jules/physics_data/biomech_files.txt 2>/dev/null || true

          # Find ball flight physics
          grep -rl "trajectory\|drag\|lift\|magnus\|spin\|launch\|landing" \
            --include="*.py" . --exclude-dir=".git" --exclude-dir="venv" \
            > .jules/physics_data/ball_flight_files.txt 2>/dev/null || true

          # Find equipment modeling
          grep -rl "club\|shaft\|loft\|lie\|gear_effect\|moi\|cg\|smash" \
            --include="*.py" . --exclude-dir=".git" --exclude-dir="venv" \
            > .jules/physics_data/equipment_files.txt 2>/dev/null || true

      - name: Jules Physics Audit
        env:
          JULES_TOKEN: ${{ secrets.JULES_API_KEY }}
          FOCUS_AREA: ${{ inputs.focus_area || 'all' }}
        run: |
          jules auth --token $JULES_TOKEN
          DATE=$(date +%Y-%m-%d)

          jules task fix --prompt "$(cat << 'PROMPT_EOF'
          You are the PHYSICS AUDITOR - a technical expert in:
          - Golf biomechanics and human movement science
          - Projectile physics and aerodynamics
          - Equipment engineering (clubs, balls, shafts)
          - Statistical modeling and uncertainty quantification

          ## Your Mission
          Perform a rigorous technical audit of the physics implementations.
          Focus area: $FOCUS_AREA

          ## Review Criteria

          ### 1. Mathematical Correctness
          - Verify formulas match established physics
          - Check unit consistency (SI vs imperial conversions)
          - Validate numerical methods (integration, interpolation)
          - Ensure proper handling of edge cases (divide by zero, NaN)

          ### 2. Physical Plausibility
          - Check parameter ranges against real-world data
          - Verify outputs are physically reasonable
          - Look for missing physical effects
          - Identify oversimplifications that matter

          ### 3. Biomechanics Accuracy
          - Kinematic sequence calculations
          - Joint angle conventions (Euler vs quaternion issues)
          - Ground reaction force modeling
          - Energy transfer calculations

          ### 4. Ball Flight Physics
          - Drag/lift coefficient models
          - Magnus effect implementation
          - Wind effects
          - Spin decay models
          - Launch conditions to landing calculations

          ### 5. Equipment Models
          - Gear effect calculations
          - Moment of inertia usage
          - CG location effects
          - Shaft flex modeling
          - Club-ball interaction

          ### 6. Statistical Methods
          - Proper use of regression techniques
          - Uncertainty propagation
          - Sample size considerations
          - Correlation vs causation issues

          ## Expert References
          Cross-reference implementations against:
          - TrackMan white papers (public domain summaries)
          - Cochran & Stobbs "Search for the Perfect Swing"
          - Jorgensen "The Physics of Golf"
          - TPI kinematic sequence research
          - R&A/USGA equipment standards

          ## Output

          Create docs/assessments/physics/Physics_Audit_$DATE.md with:

          ### Executive Summary
          - Overall physics fidelity score (1-10)
          - Critical issues count
          - Confidence in results

          ### Findings by Category
          For each finding:
          - File and line number
          - Issue description
          - Expected physics
          - Actual implementation
          - Impact assessment
          - Recommended fix

          ### Validation Recommendations
          - Test cases needed
          - Real-world data to validate against
          - Expert review areas

          ### Citations Needed
          List implementations that need academic citations

          Create GitHub Issues for:
          - Physics errors affecting output accuracy (label: physics-error, critical)
          - Missing important physical effects (label: physics-gap, high)

          DO NOT MAKE CODE CHANGES. This is an AUDIT workflow.
          PROMPT_EOF
          )"

      - name: Commit Report
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(physics): technical physics audit"
          file_pattern: "docs/assessments/physics/*.md"
