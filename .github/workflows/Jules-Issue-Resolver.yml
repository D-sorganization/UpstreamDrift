name: Jules Issue Resolver (Daily Priority Fixer)

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      max_issues:
        description: 'Maximum issues to fix per run'
        required: false
        default: '5'
        type: string
      priority_filter:
        description: 'Minimum priority (critical, high, medium)'
        required: false
        default: 'high'
        type: choice
        options:
          - critical
          - high
          - medium
  schedule:
    - cron: "0 3 * * *"  # Daily at 3 AM UTC (within midnight-4 AM window)

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: jules-issue-resolver-${{ github.repository }}
  cancel-in-progress: false

jobs:
  resolve-issues:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt || true
          pip install ruff black mypy || true
          npm install -g @google/jules

      - name: Gather Priority Issues
        id: gather
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p .jules/resolver_data

          # Get open issues sorted by priority labels
          gh issue list --state open --limit 50 --json number,title,labels,body \
            --jq '[.[] | select(.labels | map(.name) | (contains(["critical"]) or contains(["high-priority"]) or contains(["jules:code-quality"]) or contains(["needs-attention"])))]' \
            > .jules/resolver_data/priority_issues.json

          # Also read assessment summaries
          if [ -f "docs/assessments/issues/summary.md" ]; then
            cp docs/assessments/issues/summary.md .jules/resolver_data/
          fi

          if [ -f "docs/assessments/Code_Quality_Review_Latest.md" ]; then
            cp docs/assessments/Code_Quality_Review_Latest.md .jules/resolver_data/
          fi

          ISSUE_COUNT=$(cat .jules/resolver_data/priority_issues.json | jq 'length')
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $ISSUE_COUNT priority issues"

      - name: Create Fix Branch
        run: |
          BRANCH_NAME="jules/issue-resolver-$(date +%Y%m%d-%H%M)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Jules Issue Resolution
        env:
          JULES_TOKEN: ${{ secrets.JULES_API_KEY }}
          MAX_ISSUES: ${{ inputs.max_issues || '5' }}
        run: |
          jules auth --token $JULES_TOKEN

          jules task fix --prompt "$(cat << 'PROMPT_EOF'
          You are the ISSUE RESOLVER agent. Your mission is to FIX identified issues, not just document them.

          ## Input Data
          Review these sources in .jules/resolver_data/:
          - priority_issues.json - GitHub Issues marked critical/high-priority
          - summary.md - Assessment issue tracking
          - Code_Quality_Review_Latest.md - Recent quality review findings

          ## Your Mission
          1. Identify the TOP $MAX_ISSUES priority items that can be fixed
          2. ACTUALLY FIX THEM - make the code changes
          3. Document each fix clearly

          ## Priority Order
          1. CRITICAL issues (breaking/security)
          2. HIGH priority (functionality gaps)
          3. Code quality issues flagged as important

          ## Fix Guidelines
          - Make minimal, targeted changes
          - DO NOT break existing functionality
          - Run linters after changes: ruff check . --fix && black .
          - Add or update tests if needed
          - DO NOT modify test assertions just to pass

          ## For Each Fix
          1. Identify the issue/file/line
          2. Implement the fix
          3. Add a comment in the code if non-obvious
          4. Document in docs/assessments/issues/resolved/

          ## Output
          Create docs/assessments/issues/resolved/resolver_report_$(date +%Y-%m-%d).md with:
          - Issues addressed
          - Changes made
          - Issues deferred (with reason)
          - New issues discovered

          ## Closing Issues
          If your fix completely resolves a GitHub Issue, include "Fixes #NUM" in your changes
          so the PR will auto-close the issue when merged.

          IMPORTANT: You are authorized to make code changes. This is not a review - it's a FIX operation.
          PROMPT_EOF
          )"

      - name: Run Linters
        continue-on-error: true
        run: |
          ruff check . --fix || true
          black . || true

      - name: Commit and Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p docs/assessments/issues/resolved

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "fix: resolve priority issues from daily assessment

          Co-Authored-By: Jules <jules-bot@users.noreply.github.com>"

            git push origin "$BRANCH_NAME"

            PR_BODY="$(cat << 'EOF'
          ## Daily Issue Resolution

          This PR addresses priority issues identified in assessments and GitHub Issues.

          ### Review Checklist
          - [ ] Fixes don't break existing functionality
          - [ ] Tests pass
          - [ ] Changes are minimal and targeted

          See `docs/assessments/issues/resolved/` for detailed fix report.

          ---
          *Generated by Jules Issue Resolver*
          EOF
          )"
            gh pr create \
              --title "Issue Resolution - $(date +%Y-%m-%d)" \
              --body "$PR_BODY" \
              --label "jules:issue-resolver,automated-fix" || \
            gh pr create \
              --title "Issue Resolution - $(date +%Y-%m-%d)" \
              --body "$PR_BODY"
          else
            echo "No changes to commit"
          fi
