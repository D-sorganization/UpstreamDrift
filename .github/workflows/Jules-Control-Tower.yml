name: Jules Control Tower

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, closed]
  workflow_run:
    workflows: ["CI Standard"]
    types: [completed]
  schedule:
    # OVERNIGHT SCHEDULE - All work done before morning (midnight-4 AM UTC)
    - cron: "0 0 * * *"   # Midnight - Assessment Generator
    - cron: "30 0 * * *"  # 12:30 AM - Code Quality Reviewer
    - cron: "0 1 * * *"   # 1 AM - Completist (incomplete impl)
    - cron: "30 1 * * *"  # 1:30 AM - Sentinel (security) + Physics Auditor (Tue/Fri)
    - cron: "0 2 * * 1"   # 2 AM Mon - Competitor Analysis
    - cron: "0 2 * * 3"   # 2 AM Wed - Patent Review
    - cron: "30 2 * * *"  # 2:30 AM - Tech Custodian
    - cron: "0 3 * * *"   # 3 AM - Issue Resolver (daily fix)
    - cron: "30 3 * * *"  # 3:30 AM - PR Compiler (consolidate PRs)

concurrency:
  group: jules-control-tower-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  triage:
    runs-on: ubuntu-latest
    if: github.actor != 'jules-bot'
    outputs:
      target: ${{ steps.decide.outputs.target }}
    steps:
      - name: Fast API Ping (Optional)
        env:
          API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          curl -fsS -H "x-goog-api-key: $API_KEY" \
            https://jules.google/api/v1/health || echo "::warning::Jules API health check failed, continuing anyway."

      - name: Analyze Event Context
        id: decide
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            let target = "none";

            // 1. CI FAILURE -> AUTO-REPAIR or HOTFIX-CREATOR
            if (event === "workflow_run" && context.payload.workflow_run.conclusion === "failure") {
               const failedBranch = context.payload.workflow_run.head_branch;
               if (failedBranch === "main" || failedBranch === "master") {
                  target = "hotfix-creator";
               } else {
                  target = "auto-repair";
               }
            }
            // 2. SCHEDULED RUNS - Route by hour:minute (overnight schedule midnight-4 AM)
            else if (event === "schedule") {
              const now = new Date();
              const hour = now.getUTCHours();
              const minute = now.getUTCMinutes();
              const day = now.getDay();

              if (hour === 0 && minute < 30) {
                target = "assessment-generator";
              } else if (hour === 0 && minute >= 30) {
                target = "code-quality-reviewer";
              } else if (hour === 1 && minute < 30) {
                target = "completist";
              } else if (hour === 1 && minute >= 30) {
                // Physics auditor on Tue/Fri, Sentinel other days
                if (day === 2 || day === 5) {
                  target = "physics-auditor";
                } else {
                  target = "sentinel";
                }
              } else if (hour === 2 && minute < 30) {
                if (day === 1) {
                  target = "competitor-analyst";
                } else if (day === 3) {
                  target = "patent-reviewer";
                } else {
                  target = "tech-custodian";
                }
              } else if (hour === 2 && minute >= 30) {
                target = "tech-custodian";
              } else if (hour === 3 && minute < 30) {
                target = "issue-resolver";
              } else if (hour === 3 && minute >= 30) {
                target = "pr-compiler";
              } else {
                target = "none";
              }
            }
            // 3. PUSH TO MAIN -> DOCS
            else if (event === "push" && context.ref === "refs/heads/main") {
              target = "doc-scribe";
            }
            // 4. NEW PR -> TEST GENERATOR
            else if (event === "pull_request" && context.payload.action === 'opened') {
               target = "test-generator";
            }
            // 5. PR CLOSED -> ARCHIVIST
            else if (event === "pull_request" && context.payload.action === 'closed' && context.payload.pull_request.merged) {
               target = "archivist";
            }

            console.log(`Decision: Dispatching [${target}]`);
            core.setOutput("target", target);

  # --- WORKER DISPATCH ---

  call-repair:
    needs: triage
    if: needs.triage.outputs.target == 'auto-repair'
    uses: ./.github/workflows/Jules-Auto-Repair.yml
    with:
      run_id: ${{ github.event.workflow_run.id }}
      branch: ${{ github.event.workflow_run.head_branch }}
    secrets: inherit

  call-hotfix-creator:
    needs: triage
    if: needs.triage.outputs.target == 'hotfix-creator'
    uses: ./.github/workflows/Jules-Hotfix-Creator.yml
    with:
      run_id: ${{ github.event.workflow_run.id }}
      failed_branch: ${{ github.event.workflow_run.head_branch }}
    secrets: inherit

  call-auditor:
    needs: triage
    if: needs.triage.outputs.target == 'scientific-auditor'
    uses: ./.github/workflows/Jules-Scientific-Auditor.yml
    secrets: inherit

  call-scribe:
    needs: triage
    if: needs.triage.outputs.target == 'doc-scribe'
    uses: ./.github/workflows/Jules-Documentation-Scribe.yml
    secrets: inherit

  call-tests:
    needs: triage
    if: needs.triage.outputs.target == 'test-generator'
    uses: ./.github/workflows/Jules-Test-Generator.yml
    secrets: inherit

  call-custodian:
    needs: triage
    if: needs.triage.outputs.target == 'tech-custodian'
    uses: ./.github/workflows/Jules-Tech-Custodian.yml
    secrets: inherit

  call-archivist:
    needs: triage
    if: needs.triage.outputs.target == 'archivist'
    uses: ./.github/workflows/Jules-Archivist.yml
    secrets: inherit

  call-sentinel:
    needs: triage
    if: needs.triage.outputs.target == 'sentinel'
    uses: ./.github/workflows/Jules-Sentinel.yml
    secrets: inherit

  call-code-quality-reviewer:
    needs: triage
    if: needs.triage.outputs.target == 'code-quality-reviewer'
    uses: ./.github/workflows/Jules-Code-Quality-Reviewer.yml
    secrets: inherit

  call-assessment-generator:
    needs: triage
    if: needs.triage.outputs.target == 'assessment-generator'
    uses: ./.github/workflows/Jules-Assessment-Generator.yml
    secrets: inherit

  call-issue-resolver:
    needs: triage
    if: needs.triage.outputs.target == 'issue-resolver'
    uses: ./.github/workflows/Jules-Issue-Resolver.yml
    secrets: inherit

  call-completist:
    needs: triage
    if: needs.triage.outputs.target == 'completist'
    uses: ./.github/workflows/Jules-Completist.yml
    secrets: inherit

  call-physics-auditor:
    needs: triage
    if: needs.triage.outputs.target == 'physics-auditor'
    uses: ./.github/workflows/Jules-Physics-Auditor.yml
    secrets: inherit

  call-competitor-analyst:
    needs: triage
    if: needs.triage.outputs.target == 'competitor-analyst'
    uses: ./.github/workflows/Jules-Competitor-Analyst.yml
    secrets: inherit

  call-patent-reviewer:
    needs: triage
    if: needs.triage.outputs.target == 'patent-reviewer'
    uses: ./.github/workflows/Jules-Patent-Reviewer.yml
    secrets: inherit

  call-pr-compiler:
    needs: triage
    if: needs.triage.outputs.target == 'pr-compiler'
    uses: ./.github/workflows/Jules-PR-Compiler.yml
    secrets: inherit
