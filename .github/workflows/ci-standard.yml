name: CI Standard
on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install ruff==0.14.10 black==25.12.0 mypy bandit pydocstyle

      # FIX: Less aggressive Ruff (Errors, Warnings, Imports only)
      - name: Lint
        run: ruff check src scripts tests

      # FIX: Enforce Black formatting (88 chars)
      - name: Check Formatting
        run: black --check src scripts tests

      - run: pip install mypy types-PyYAML types-requests
      - run: pip install -e .[dev]
      - run: mypy src --config-file pyproject.toml

      # TODO detection now BLOCKING - Jules Auto-Repair will fix
      - name: Verify No Placeholders
        run: |
          violations=$(
            find . \( -path "./.git" -o -path "./.mypy_cache" -o -path "./.ruff_cache" -o -path "./__pycache__" -o -path "./archive" -o -path "./check_code_quality" -o -path "./scripts" \) -prune -o -type f -name "*.py" -print0 \
              | xargs -0 grep -nE "TODO|FIXME" || true
          )
          if [ -n "$violations" ]; then
            echo "$violations"
            echo "::error::Placeholders found. Remove TODOs/FIXMEs or create tracked GitHub issues."
            exit 1
          fi

      # SECURITY FIX: Make security audit blocking (fail on vulnerabilities)
      - name: Security Audit
        run: |
          pip install pip-audit
          # Ignore CVEs with no fix version available presently:
          # - CVE-2024-23342 (ecdsa): No fix version available
          # - CVE-2026-0994 (protobuf): No fix version available - transitive dep from dm_control
          pip-audit --ignore-vuln CVE-2024-23342 --ignore-vuln CVE-2026-0994

      # SECURITY: Bandit static security analysis (Issue #782)
      - name: Bandit Security Scan
        run: |
          bandit_output="$(bandit -r . -x ./tests,./archive,./legacy,./.git -ll -ii --format txt 2>&1 || true)"
          echo "$bandit_output"
          echo "## Security Scan Results" >> "$GITHUB_STEP_SUMMARY"
          echo "$bandit_output" >> "$GITHUB_STEP_SUMMARY"

      # Code Quality Check (Issue #781) - checks for placeholders, magic numbers, etc.
      - name: Code Quality Check
        run: |
          python tools/code_quality_check.py || echo "::warning::Code quality issues found - see output above"

      - name: MATLAB Quality Check
        continue-on-error: true
        run: |
          python src/tools/matlab_utilities/scripts/matlab_quality_check.py --output-format text > matlab_quality_report.txt
          cat matlab_quality_report.txt

      - name: Upload MATLAB Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: matlab-quality-report
          path: matlab_quality_report.txt

  tests:
    needs: quality-gate
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent runaway tests - hard cutoff
    strategy:
      matrix:
        python: ["3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 libgl1 xvfb \
            libxkbcommon-x11-0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xinerama0 \
            libxcb-xkb1
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - run: pip install -e .[dev]
      - name: Run Tests
        env:
          PYTHONPATH: .:src:src/engines/physics_engines/mujoco/python:src/engines/physics_engines/mujoco/python/mujoco_humanoid_golf
          QT_QPA_PLATFORM: offscreen
        run: |
          # Install test dependencies if not already installed
          pip install pytest pytest-cov pytest-mock pytest-qt pytest-timeout pytest-xdist
          # Run tests with:
          # - Parallel execution (-n auto)
          # - 60 second timeout per test
          # - Skip slow tests in CI for faster feedback
          xvfb-run --auto-servernum pytest \
            -n auto \
            --timeout=60 \
            --timeout-method=thread \
            -m "not slow and not benchmark" \
            --tb=short \
            -v

      # Cross-Engine Validator Unit Tests (C-001 Remediation)
      # These run on every PR to catch framework issues immediately
      - name: Cross-Engine Validation (Unit Tests)
        env:
          PYTHONPATH: .:src:src/engines/physics_engines/mujoco/python:src/engines/physics_engines/mujoco/python/mujoco_humanoid_golf
          QT_QPA_PLATFORM: offscreen
        run: |
          echo "## Cross-Engine Validation (Unit Tests)" >> $GITHUB_STEP_SUMMARY
          xvfb-run --auto-servernum pytest tests/integration/test_cross_engine_validation.py::TestCrossEngineValidator \
            --timeout=60 \
            --timeout-method=thread \
            -v --tb=short 2>&1 | tee cross-engine-results.txt || true

          # Report to summary
          passed=$(grep -c "PASSED" cross-engine-results.txt || echo "0")
          failed=$(grep -c "FAILED" cross-engine-results.txt || echo "0")
          echo "✅ Passed: $passed | ❌ Failed: $failed" >> $GITHUB_STEP_SUMMARY
      - uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        if: env.CODECOV_TOKEN != ''
        with:
          fail_ci_if_error: false # Do not block if token is missing
          token: ${{ secrets.CODECOV_TOKEN }}

  javascript-tests:
    needs: quality-gate
    runs-on: ubuntu-latest
    if: false # Disabled - no JavaScript components in this project
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - name: Install & Test
        working-directory: ./javascript
        run: |
          npm ci
          npm run test:coverage

  matlab-tests:
    needs: quality-gate
    runs-on: ubuntu-latest
    if: false
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: matlab-actions/setup-matlab@v2
      - uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath('matlab');
            run_all

  arduino-build:
    needs: quality-gate
    runs-on: ubuntu-latest
    if: false # Disabled - no Arduino components in this project
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install platformio
      - name: Verify Build
        working-directory: ./arduino
        run: pio run -e uno
